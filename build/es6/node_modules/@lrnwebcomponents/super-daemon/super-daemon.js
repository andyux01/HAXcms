/**
 * Copyright 2023 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as e,html as t,css as i}from"../../lit/index.js";import"../simple-icon/lib/simple-icon-button.js";import"../../web-dialog/index.js";import"../absolute-position-behavior/absolute-position-behavior.js";import"./lib/super-daemon-ui.js";class SuperDaemon extends e{static get properties(){return{opened:{type:Boolean,reflect:!0},loading:{type:Boolean,reflect:!0},key1:{type:String},key2:{type:String},icon:{type:String},items:{type:Array},programResults:{type:Array},programName:{type:String},allItems:{type:Array},context:{type:Array},commandContext:{type:String},program:{type:String},programSearch:{type:String},like:{type:String},value:{type:String},mini:{type:Boolean},activeNode:{type:Object}}}constructor(){super(),this.activeSelection=null,this.activeRange=null,this.activeNode=null,this.value="",this.icon="hardware:keyboard-return",this.context=[],this.opened=!1,this.items=[],this.loading=!1,this.like="",this.mini=!1,this._programValues={},this.programSearch="",this.allItems=[],this.programResults=[],this.programName=null,this.commandContext="*";const e=void 0!==window.safari;this.key1=e?"Ctrl":"Alt",this.key2="Shift"}connectedCallback(){super.connectedCallback(),window.addEventListener("keydown",this.keyHandler.bind(this)),window.addEventListener("super-daemon-define-option",this.defineOptionEvent.bind(this)),window.addEventListener("super-daemon-element-method",this.elementMethod.bind(this)),window.addEventListener("super-daemon-element-click",this.elementClick.bind(this)),window.addEventListener("super-daemon-run-program",this.runProgramEvent.bind(this))}disconnectedCallback(){super.connectedCallback(),window.removeEventListener("keydown",this.keyHandler.bind(this)),window.removeEventListener("click",this.clickOnMiniMode.bind(this),{once:!0,passive:!0}),window.removeEventListener("super-daemon-define-option",this.defineOptionEvent.bind(this)),window.removeEventListener("super-daemon-element-method",this.elementMethod.bind(this)),window.removeEventListener("super-daemon-element-click",this.elementClick.bind(this)),window.removeEventListener("super-daemon-run-program",this.runProgramEvent.bind(this))}runProgram(e="/",t={},i=null,o=null,s="",a=null){this.commandContext=e,this._programToRun=i,this.programSearch=s,null!=a&&(this.like=a),this._programToRun?(this.shadowRoot.querySelector("super-daemon-ui").setupProgram(),setTimeout((async()=>{try{this.loading=!0,this.programResults=await this._programToRun(this.programSearch,t),this.loading=!1}catch(e){this.loading=!1}}),50)):this.programResults=[],this.programName=o}runProgramEvent(e){if(e.detail){let t=e.detail;this._programValues=t,this.like="",this.runProgram(t.context,this._programValues,t.program,t.name,"")}else this.runProgram("/"),this._programValues={}}elementMethod(e){if(e.detail){let t=e.detail;t.args||(t.args=[]),t.target[t.method](...t.args)}}elementClick(e){e.detail&&e.detail.target.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}defineOptionEvent(e){this.defineOption(e.detail)}defineOption(e){if(e&&e.value&&e.title&&e.eventName){e.tags||(e.tags=[]),e.key||(e.key=""),e.path||(e.path=""),e.priority||(e.priority=0);let t={...e};delete t.icon,delete t.image,delete t.value,delete t.eventName,t=Object.values(t).filter((e=>{if(!["boolean","number"].includes(typeof e)&&""!==e&&null!=e)return!0}));let i=[];t.map((e=>{if("string"==typeof e){e.split("/").map((e=>{["","*","/"," ","?",">"].includes(e)||i.push(e.toLowerCase())}))}else Array.isArray(e)&&e.map((e=>{["","*","/"," ","?",">"].includes(e)||i.push(e.toLowerCase())}))}));let o=i.join(" ").replace(/\*/g,"").replace(/\?/g,"");i=[...new Set(o.split(" "))],e.index=i.join(" ")+" "+e.path,this.allItems.push(e)}}keyHandler(e){this.allowedCallback()&&("Shift"==this.key2&&e.shiftKey&&("Ctrl"==this.key1&&e.ctrlKey||"Alt"==this.key1&&e.altKey)&&(this.opened=!this.opened,this.opened&&(this.mini=!1)),"Escape"==e.key&&this.opened&&this.miniCancel())}static get styles(){let e=[];return super.styles&&(e=super.styles),[...e,i`
        :host {
          display: none;
        }
        :host([opened]) {
          display: block;
        }
        web-dialog {
          --dialog-border-radius: var(--simple-modal-border-radius, 2px);
          z-index: var(--simple-modal-z-index, 1) !important;
          padding: 0;
        }
        web-dialog::part(dialog) {
          border: 1px solid var(--simple-modal-border-color, #222);
          min-height: var(--simple-modal-min-height, unset);
          min-width: var(--simple-modal-min-width, unset);
          z-index: var(--simple-modal-z-index, 1000);
          resize: var(--simple-modal-resize, unset);
          padding: 0;
          --dialog-height: var(--simple-modal-height, auto);
          --dialog-width: var(--simple-modal-width, 75vw);
          --dialog-max-width: var(--simple-modal-max-width, 100vw);
          --dialog-max-height: var(--simple-modal-max-height, 100vh);
        }
        web-dialog.style-scope.simple-modal {
          display: none !important;
        }
        web-dialog[open].style-scope.simple-modal {
          display: flex !important;
          position: fixed !important;
          margin: auto;
        }
        :host([resize="none"]) web-dialog[open].style-scope.simple-modal,
        :host([resize="horizontal"]) web-dialog[open].style-scope.simple-modal {
          top: calc(50% - var(--simple-modal-height, auto) / 2);
        }
        :host([resize="none"]) web-dialog[open].style-scope.simple-modal,
        :host([resize="vertical"]) web-dialog[open].style-scope.simple-modal {
          left: calc(50% - var(--simple-modal-width, 75vw) / 2);
        }
        #cancel {
          position: absolute;
          right: 0px;
          top: 0px;
          z-index: 100000000;
          display: block;
          margin: 0;
          --simple-icon-width: 24px;
          --simple-icon-height: 24px;
        }
        absolute-position-behavior {
          z-index: var(--simple-modal-z-index, 1000);
          min-width: 280px;
        }
        absolute-position-behavior super-daemon-ui {
          margin-top: -46px;
          background-color: white;
          width: 400px;
          margin-left: 14px;
          padding-top: 8px;
        }
      `]}close(){this.opened=!1,this.activeNode=null,this.loading=!1,this.like="",this.mini=!1,this._programValues={},this.programSearch="",this.programResults=[],this.programName=null,this.commandContext="*";const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});document.dispatchEvent(e),window.removeEventListener("click",this.clickOnMiniMode.bind(this),{once:!0,passive:!0}),window.ShadyCSS&&!window.ShadyCSS.nativeShadow&&(this.shadowRoot.querySelector("web-dialog").shadowRoot.querySelector("#backdrop").style.position="relative")}filterItems(e,t){let i=e.filter((e=>{if(e.context){let i=[];return i="*"==this.commandContext?t.filter((t=>e.context.includes(t))):[this.commandContext].filter((t=>e.context.includes(t))),0!==i.length}return!0}));return i.sort(((e,t)=>{var i=e.title.toUpperCase(),o=t.title.toUpperCase();return i<o?-1:i>o?1:0})),i.sort(((e,t)=>e.priority<t.priority?-1:e.priority>t.priority?1:0))}appendContext(e){e&&!this.context.includes(e)&&this.context.push(e)}removeContext(e){e&&this.context.includes(e)&&this.context.splice(this.context.indexOf(e),1)}clickOnMiniMode(e){e.target!==this&&this.miniCancel()}miniCancel(){if(this.activeNode&&this.activeNode.focus&&this.mini&&this.activeRange&&this.activeSelection)try{this.activeNode.textContent=this.value,this.activeNode.focus(),this.activeRange.setStart(this.activeNode,0),this.activeRange.collapse(!0),this.activeSelection.removeAllRanges(),this.activeSelection.addRange(this.activeRange),this.activeSelection.selectAllChildren(this.activeNode),this.activeSelection.collapseToEnd()}catch(e){console.warn(e)}this.close()}open(){this.items=this.filterItems(this.allItems,this.context),this.opened=!0;const e=this.shadowRoot.querySelector("web-dialog");e&&(e.$backdrop.addEventListener("click",e.onBackdropClick),e.addEventListener("keydown",e.onKeyDown,{capture:!0,passive:!0}),window.ShadyCSS&&!window.ShadyCSS.nativeShadow&&(this.shadowRoot.querySelector("web-dialog").shadowRoot.querySelector("#backdrop").style.position="fixed",this.shadowRoot.querySelector("web-dialog").shadowRoot.querySelector("#backdrop").style.top=0,this.shadowRoot.querySelector("web-dialog").shadowRoot.querySelector("#backdrop").style.bottom=0,this.shadowRoot.querySelector("web-dialog").shadowRoot.querySelector("#backdrop").style.left=0,this.shadowRoot.querySelector("web-dialog").shadowRoot.querySelector("#backdrop").style.right=0)),window.removeEventListener("click",this.clickOnMiniMode.bind(this),{once:!0,passive:!0}),setTimeout((()=>{this.mini&&window.addEventListener("click",this.clickOnMiniMode.bind(this),{once:!0,passive:!0}),this.shadowRoot.querySelector("super-daemon-ui").shadowRoot.querySelector("simple-fields-field").focus(),this.shadowRoot.querySelector("super-daemon-ui").shadowRoot.querySelector("simple-fields-field").select()}),0)}focusout(e){if(e){let t=e.relatedTarget;for(;t!==document.body&&null!==t;){if(t===this.shadowRoot.querySelector("super-daemon-ui"))return;if(!t||!t.parentElement)return;t=t.parentElement}t!==this.shadowRoot.querySelector("super-daemon-ui")&&setTimeout((()=>{this.opened&&(this.shadowRoot.querySelector("super-daemon-ui").shadowRoot.querySelector("simple-fields-field").focus(),this.shadowRoot.querySelector("super-daemon-ui").shadowRoot.querySelector("simple-fields-field").select())}),0)}}noResultsSlot(e){}render(){return t`${this.mini?t`
          <absolute-position-behavior
            justify
            position="bottom"
            allow-overlap
            sticky
            auto
            .target="${this.activeNode}"
            ?hidden="${!this.opened}"
          >
            <super-daemon-ui
              ?open="${this.opened}"
              ?mini="${this.mini}"
              icon="${this.icon}"
              ?loading="${this.loading}"
              like="${this.like}"
              .items="${this.itemsForDisplay(this.items,this.programResults)}"
              command-context="${this.commandContext}"
              program-name="${this.programName}"
              program-search="${this.programSearch}"
              @value-changed="${this.inputfilterChanged}"
              @super-daemon-close="${this.close}"
              @super-daemon-command-context-changed="${this.commandContextChanged}"
            ></super-daemon-ui>
          </absolute-position-behavior>
        `:t`
          <web-dialog
            id="dialog"
            center
            role="dialog"
            part="dialog"
            aria-label="Super Daemon"
            aria-modal="true"
            ?open="${this.opened}"
            @open="${this.open}"
            @close="${this.close}"
            @focusout="${this.focusout}"
          >
            <super-daemon-ui
              ?open="${this.opened}"
              icon="${this.icon}"
              ?loading="${this.loading}"
              like="${this.like}"
              @like-changed="${this.likeChanged}"
              .items="${this.itemsForDisplay(this.items,this.programResults)}"
              command-context="${this.commandContext}"
              program-name="${this.programName}"
              program-search="${this.programSearch}"
              @value-changed="${this.inputfilterChanged}"
              @super-daemon-close="${this.close}"
              @super-daemon-command-context-changed="${this.commandContextChanged}"
              >${this.noResultsSlot(this.like||this.programSearch)}</super-daemon-ui
            >
            <simple-icon-button
              id="cancel"
              icon="cancel"
              @click="${this.close}"
            ></simple-icon-button>
          </web-dialog>
        `} `}likeChanged(e){this.like=e.detail.value}async inputfilterChanged(e){this.value=e.detail.value,this.programName&&this._programToRun?(this.loading=!0,this.programResults=await this._programToRun(e.detail.value,this._programValues),this.loading=!1):(this.programResults=[],this.items=this.filterItems(this.allItems,this.context))}itemsForDisplay(e,t){return null!=this.programName?t:e}commandContextChanged(e){if(e.detail.value)switch(e.detail.value){case"/":case"*":case"?":case">":this.commandContext=e.detail.value,this.items=this.filterItems(this.allItems,this.context)}else this.commandContext="*",this.items=this.filterItems(this.allItems,this.context)}allowedCallback(){return!0}static get tag(){return"super-daemon"}}customElements.define(SuperDaemon.tag,SuperDaemon);export{SuperDaemon};window.SuperDaemonManager=window.SuperDaemonManager||{},window.SuperDaemonManager.requestAvailability=()=>(window.SuperDaemonManager.instance||(window.SuperDaemonManager.instance=document.createElement("super-daemon"),document.body.appendChild(window.SuperDaemonManager.instance)),window.SuperDaemonManager.instance);export const SuperDaemonInstance=window.SuperDaemonManager.requestAvailability();