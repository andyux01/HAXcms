/**
 * Copyright 2021
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as e,html as o,css as t}from"../../lit-element/lit-element.js";import"../es-global-bridge/es-global-bridge.js";class BarcodeReader extends e{static get styles(){return t`
      :host {
        display: block;
        position: relative;
      }
      canvas {
        display:none;
      }
      video {
        width: 100%;
        height: 100%;
      }
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-color: transparent;
        border-style: solid;
        border-color: rgba(0, 0, 0, 0.5);
        pointer-events: none;
        z-index: 20;
        border-width: 2em;
      }
      #scanline {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        visibility: hidden;
        background: linear-gradient(to bottom, transparent 51%, red 51%, transparent 52%)
      }
    `}render(){return o`
      <!--<div>
        <div id="overlay">
          <div id="scanline"></div>
        </div>
        <canvas id="canvas" width="640" height="480"></canvas>
        <video id="video" width="640" height="480" muted autoplay playsinline/>
      </div>
      <pre><code id="result"></code></pre>
      <div>
        <a class="button" id="startButton">Start</a>
        <a class="button" id="resetButton">Reset</a>
        <p id="result">Result:</p>
      </div>-->
        <br><br><br><br><br><br>
      <h1>Pure JS Barcode Reader</h1>
      <div>Barcode result: <span id="dbr"></span></div>
      <div class="select">
        <label for="videoSource">Video source: </label><select id="videoSource"></select>
      </div>
      <button id="go">Read Barcode</button>
      <div>
        <video muted autoplay id="video" playsinline="true"></video>
        <canvas id="canvas" width="640" height="480" style="display: none; float: bottom;"></canvas>
      </div>
    `}constructor(){super(),window.ESGlobalBridge.requestAvailability(),window.ESGlobalBridge.instance.load("ZXing",decodeURIComponent(import.meta.url)+"/../lib/zxing.js"),window.addEventListener("es-bridge-zxing-loaded",this._control.bind(this))}_control(){let e=this.shadowRoot.querySelector("#video"),o=this.shadowRoot.querySelector("#canvas"),t=o.getContext("2d");var i=this.shadowRoot.querySelector("select#videoSource");this.shadowRoot.getElementById("videoOption");let a=this.shadowRoot.getElementById("go"),d=this.shadowRoot.getElementById("dbr"),r=!1,n=!0,s=null,l=null;var tick=function(){console.log("tick"),window.ZXing?(s=s(),l=s.Runtime.addFunction(decodeCallback)):setTimeout(tick,10)};tick();var decodeCallback=function(e,t,i,r){console.log("decodeCallback");var l=new Uint8Array(s.HEAPU8.buffer,e,t);console.log(String.fromCharCode.apply(null,l)),d.textContent=String.fromCharCode.apply(null,l),a.disabled=!1,n?o.style.display="block":mobileCanvas.style.display="block"};function scanBarcode(){if(console.log("scanBarcode"),d.textContent="",null==s)return a.disabled=!1,void alert("Barcode Reader is not ready!");var o=null,i=0,r=0;n?(o=t,i=640,r=480):(o=mobileCtx,i=240,r=320,mobileCanvas),o.drawImage(e,0,0,i,r);var c=this.shadowRoot.getElementById("video");console.log("video width: "+c.videoWidth+", height: "+c.videoHeight);var h=document.createElement("canvas");h.width=c.videoWidth,h.height=c.videoHeight;var v=h.getContext("2d"),m=c.videoWidth,g=c.videoHeight;v.drawImage(e,0,0,m,g);var u=v.getImageData(0,0,m,g).data,b=s._resize(m,g);console.time("decode barcode");for(var p=0,w=0;p<u.length;p+=4,w++)s.HEAPU8[b+w]=u[p];var y=s._decode_any(l);console.timeEnd("decode barcode"),console.log("error code",y),-2==y&&setTimeout(scanBarcode,30)}n="pc"==function browserRedirect(){console.log("browserRedirect");var e=navigator.userAgent.toLowerCase(),o="ipad"==e.match(/ipad/i),t="iphone os"==e.match(/iphone os/i),i="midp"==e.match(/midp/i),a="rv:1.2.3.4"==e.match(/rv:1.2.3.4/i),d="ucweb"==e.match(/ucweb/i),r="android"==e.match(/android/i),n="windows ce"==e.match(/windows ce/i),s="windows mobile"==e.match(/windows mobile/i);return o||t||i||a||d||r||n||s?"phone":"pc"}(),a.onclick=function(){console.log("Click"),n?o.style.display="none":mobileCanvas.style.display="none",r=!1,scanBarcode(),a.disabled=!0};i=this.shadowRoot.querySelector("select#videoSource");function getStream(){console.log("getStream"),a.disabled=!1,window.stream&&window.stream.getTracks().forEach((function(e){e.stop()}));var e={video:{deviceId:{exact:i.value}}};navigator.mediaDevices.getUserMedia(e).then(gotStream).catch(handleError)}function gotStream(o){console.log("gotStream"),window.stream=o,e.srcObject=o}function handleError(e){console.log("handleError"),console.log("Error: ",e)}navigator.mediaDevices.enumerateDevices().then((function gotDevices(e){console.log("gotDevices");for(var o=e.length-1;o>=0;--o){var t=e[o],a=document.createElement("option");a.value=t.deviceId,"videoinput"===t.kind?(a.text=t.label||"camera "+(i.length+1),i.appendChild(a)):console.log("Found one other kind of source/device: ",t)}})).then(getStream).catch(handleError),i.onchange=getStream}static get tag(){return"barcode-reader"}firstUpdated(){this.start().then(e=>console.log("Hit")),this.__context=this.shadowRoot.querySelector("canvas").getContext("2d"),this.__video=this.shadowRoot.querySelector("video"),this.__videoInputSelector=this.shadowRoot.querySelector("#videoInput")}async _onFrame(){var e;await(e=5e3,new Promise(o=>setTimeout(o,e))),this.__video.videoWidth>0&&this._drawFrame(this.__video),this.__animationFrameId=requestAnimationFrame(this._onFrame.bind(this))}_drawFrame(e){this.__context.drawImage(e,0,0,640,480,0,0,640,480),this._processFrame().then(e=>console.log("Hit draw frame promise#1"))}async _processFrame(){console.log("Hit Process Frame");this.shadowRoot.querySelector("#video");console.log("After hit")}async start(){this._control();const e=await navigator.mediaDevices.getUserMedia({audio:!1,video:{width:{min:640,ideal:640,max:1280},height:{min:480,ideal:480,max:720}}});this.__video.addEventListener("loadeddata",e=>{this.__animationFrameId=requestAnimationFrame(this._onFrame.bind(this))}),this.__video.srcObject=e,this.__stream=e}stop(){this.__stream.getTracks()[0].stop()}}customElements.define(BarcodeReader.tag,BarcodeReader);export{BarcodeReader};