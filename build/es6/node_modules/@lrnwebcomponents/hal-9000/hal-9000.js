/**
 * Copyright 2019 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as t}from"../../lit/index.js";import"../es-global-bridge/es-global-bridge.js";import"../simple-toast/simple-toast.js";class Hal9000 extends t{static get properties(){return{toast:{type:Boolean,reflect:!0},commands:{name:"commands",type:Object},respondsTo:{name:"respondsTo",type:String,attribute:"responds-to"},debug:{name:"debug",type:Boolean},auto:{name:"auto",type:Boolean,reflect:!0},enabled:{name:"enabled",type:Boolean,reflect:!0},pitch:{name:"pitch",type:Number,reflect:!0},rate:{name:"rate",type:Number,reflect:!0},language:{name:"language",type:String,reflect:!0}}}static get tag(){return"hal-9000"}constructor(){super(),this.toast=!1,this.windowControllers=new AbortController,this.commands={},this.respondsTo="(merlin)",this.debug=!1,this.pitch=.9,this.rate=.9,this.language=navigator.language,window.Hal9000=window.Hal9000||{},window.Hal9000.instance=this;const t=`${new URL("./lib/annyang/annyang.min.js",import.meta.url).href}`;if(window.addEventListener("es-bridge-annyang-loaded",this._annyangLoaded.bind(this),{signal:this.windowControllers.signal}),window.ESGlobalBridge.requestAvailability().load("annyang",t),void 0!==window.speechSynthesis){this.synth=window.speechSynthesis,this.voices=this.synth.getVoices();for(var n=0;n<this.voices.length;n++)this.voices[n].default&&(this.defaultVoice=this.voices[n].name)}}_commandsChanged(t){this.addCommands(t)}addCommands(t){if(this.annyang){if(this.annyang.removeCommands(),t["*anything"]){const n=t["*anything"];delete t["*anything"],t["*anything"]=n}this.annyang.addCommands(t)}}speak(t,n=!1,e=!0){return new Promise((a=>{this.__text=t,this.synth?(this.utter=new SpeechSynthesisUtterance(this.__text),this.utter.pitch=this.pitch,this.utter.rate=this.rate,this.utter.lang=this.language,this.utter.voice=this.defaultVoice,this.synth.speak(this.utter),this.toast&&this.sendToast(t,n,e),this.utter.onend=t=>{let s="simple";(window.AppHax||window.HAXCMS)&&(s="haxcms"),n||e||window.dispatchEvent(new CustomEvent(`${s}-toast-hide`,{bubbles:!0,composed:!0,cancelable:!1,detail:!1})),a(t)}):a(!1)}))}sendToast(t,n=!1,e=!0){let a="simple";(window.AppHax||window.HAXCMS)&&(a="haxcms"),window.dispatchEvent(new CustomEvent(`${a}-toast-show`,{bubbles:!0,composed:!0,cancelable:!0,detail:{text:t,future:!0,merlin:!0,accentColor:"purple",duration:4e3,alwaysvisible:n,awaitingMerlinInput:e}}))}_annyangLoaded(){if(this.annyang=window.annyang,this.annyang){this.annyang.addCommands(this.commands),this.annyang.debug(this.debug),this.auto?this.annyang.start({autoRestart:!0,continuous:!0}):this.enabled&&this.annyang.start();const t=new CustomEvent("hal-9000-online",{bubbles:!0,cancelable:!1,detail:!0});this.dispatchEvent(t)}}_respondsToChanged(t,n){this.annyang&&this.annyang.removeCommands();var e={};for(var a in this.commands)a.replace(n,t)!==a?e[a.replace(n,t)]=this.commands[a]:e[a]=this.commands[a];e.length>0&&(this.commands={...e})}_autoChanged(t){this.enabled=t}_enabledChanged(t){this.annyang&&(t?this.auto?this.annyang.start({autoRestart:!0,continuous:!0}):this.annyang.start():this.annyang.abort())}_debugChanged(t,n){this.annyang&&this.annyang.debug(t)}updated(t){t.forEach(((t,n)=>{"commands"==n&&void 0!==t&&this._commandsChanged(this[n]),"respondsTo"==n&&this._respondsToChanged(this[n],t),"debug"==n&&this._debugChanged(this[n],t),"auto"==n&&this._autoChanged(this[n],t),"enabled"==n&&this._enabledChanged(this[n],t)}))}disconnectedCallback(){this.windowControllers.abort(),super.disconnectedCallback()}}customElements.define(Hal9000.tag,Hal9000);export{Hal9000};window.Hal9000=window.Hal9000||{},window.Hal9000.requestAvailability=()=>{if(!window.Hal9000.instance){const t=document.createElement("hal-9000");document.body.appendChild(t),window.Hal9000.instance=t}return window.Hal9000.instance};export const HAL9000Instance=window.Hal9000.requestAvailability();