/**
 * Copyright 2023
 * @license , see License.md for full text.
 */
import{localStorageSet as t,localStorageGet as e,localStorageDelete as i,validURL as r}from"../utils/utils.js";import{observable as a,makeObservable as s,computed as n,configure as o,autorun as l,toJS as d}from"../../mobx/dist/mobx.esm.js";o({enforceActions:!1}),window.UserScaffold=window.UserScaffold||{},window.UserScaffold.requestAvailability=()=>(window.UserScaffold.instance||(window.UserScaffold.instance=document.createElement("user-scaffold"),document.body.appendChild(window.UserScaffold.instance)),window.UserScaffold.instance);export const UserScaffoldInstance=window.UserScaffold.requestAvailability();export class UserScaffold extends HTMLElement{static get tag(){return"user-scaffold"}constructor(){super(),this.debug=!1,this.windowControllers=new AbortController,this.stMemory={interactionDelay:0,interactionCount:0},this.ltMemory=e("user-scaffold-ltMemory",{}),this.action={type:null,architype:null},this.data={raw:null,value:null,architype:null},this.active=!0,this.userActionArchitypes(),s(this,{debug:a,stMemory:a,ltMemory:a,action:a,data:a,active:a,memory:n}),l((()=>{this.debug&&console.trace(this)}))}userActionArchitypes(){this.interactionInterval=setInterval((()=>{this.active&&this.readMemory("interactionDelay")<=3e3&&this.incrementWriteMemory("interactionDelay",600)}),300),window.addEventListener("click",this.userMouseAction.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("paste",this.userPasteAction.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("keydown",this.userKeyDownAction.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("drop",this.userDropAction.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("dragover",this.userDragAction.bind(this),{signal:this.windowControllers.signal})}userKeyDownAction(t){t.isTrusted&&(this.action={type:"key",architype:"input"},this.data={raw:t.key,value:t.key,architype:"text"},this.writeMemory("recentTarget",t.target),this.writeMemory("interactionDelay",0))}userPasteAction(t){if(t.isTrusted){this.action={type:"paste",architype:"input"};let e="",i="text";t.clipboardData||t.originalEvent.clipboardData?(e=(t.originalEvent||t).clipboardData.getData("text/html"),""==e?e=(t.originalEvent||t).clipboardData.getData("text"):i="text/html"):window.clipboardData&&(e=window.clipboardData.getData("Text"));const a=e;e=e.trim(),e=e.replace(/<span>\s*?<\/span>/g," "),e=e.replace(/(?:style="(\S+:\s*[^;"]+;\s*)*)+"/g,""),e=e.replace(/<div/g,"<p"),e=e.replace(/<\/div>/g,"</p>");let s=e;this.isBase64(e)?(i="base64",s=this.isBase64(e)):t.clipboardData.files.length>0?(i="file",t.clipboardData.files.length>1&&(i="files")):r(e)&&(i="url"),this.data={raw:a,value:s,architype:i}}}userDropAction(t){t.preventDefault(),t.isTrusted&&t.dataTransfer&&t.dataTransfer.items&&t.dataTransfer.items.length>0&&(this.action={type:"drop",architype:"input"},this.data={raw:t.dataTransfer.items[0].type,value:t.dataTransfer.items[0].type,architype:t.dataTransfer.items[0].kind})}userDragAction(t){t.isTrusted&&t.dataTransfer&&t.dataTransfer.items&&t.dataTransfer.items.length>0&&(this.action={type:"drag",architype:"input"},this.data={raw:t.dataTransfer.items[0].type,value:t.dataTransfer.items[0].type,architype:t.dataTransfer.items[0].kind})}userMouseAction(t){t.isTrusted&&(this.action={type:"click",architype:"input"},this.writeMemory("recentTarget",t.target),this.writeMemory("interactionDelay",0),this.incrementWriteMemory("interactionCount",1))}incrementWriteMemory(t,e,i="short"){let r="stMemory";"long"==i&&(r="ltMemory"),this.writeMemory(t,this[r][t]+e,i)}writeMemory(e,i,r="short"){let a="stMemory";"long"==r?(a="ltMemory",this[a][e]=i,t(`user-scaffold-${a}`,this[a])):this[a][e]=i}deleteMemory(t,e="short"){let r="stMemory";"long"==e?(r="ltMemory",delete this[r][t],i(`user-scaffold-${r}`)):delete this[r][t]}readMemory(t){return this.memory[t]?d(this.memory[t]):null}get memory(){return{...this.ltMemory,...this.stMemory}}isBase64(t){try{return btoa(atob(t))==t}catch(t){return!1}}disconnectedCallback(){this.windowControllers.abort(),super.disconnectedCallback()}}customElements.define(UserScaffold.tag,UserScaffold);